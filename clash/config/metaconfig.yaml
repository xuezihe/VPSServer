# 官方参考配置 https://github.com/MetaCubeX/Clash.Meta/blob/Alpha/docs/config.yaml
# 官方配置详解 https://wiki.metacubex.one/config/

mixed-port: 7890
allow-lan: true
bind-address: "*"
find-process-mode: strict
mode: rule
#自定义 geodata url
geodata-mode: true
geodata-loader: memconservative
geox-url:
  geoip: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat"
  geosite: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat"
  mmdb: "https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb"
global-ua: clash.meta
log-level: info
ipv6: true
# RESTful API 监听地址
external-controller: 127.0.0.1:9090
secret: 1j8Dm52W2nS4aV69Fw15
# 配置 WEB UI 目录，使用 http://{{external-controller}}/ui 访问
external-ui: MetaCubeXD
external-ui-url: "https://ghproxy.net/https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip"

unified-delay: false
#  TCP 并发连接所有 IP, 将使用最快握手的 TCP
tcp-concurrent: true

global-client-fingerprint: chrome
#  TCP keep alive interval
keep-alive-interval: 30


profile:
  # 存储 select 选择记录
  store-selected: false
   # 持久化 fake-ip
  store-fake-ip: false

tun:
  enable: false
  stack: system
  auto-route: true
  auto-detect-interface: true
  strict_route: true
  dns-hijack:
    - any:53

sniffer:
  enable: true
  force-dns-mapping: true
  parse-pure-ip: true
  override-destination: false
  sniff:
    HTTP:
      ports: [80]
      override-destination: true
    TLS:
      ports: [443]
    QUIC:
      ports: [443]
  # force-domain:
  #   - +.v2ex.com
  # skip-domain:
  #   - Mijia Cloud

dns:
  enable: true
  prefer-h3: true
  listen: 0.0.0.0:53
  ipv6: false
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - "+.stun.*.*"
    - "+.stun.*.*.*"
    - "+.stun.*.*.*.*"
    - "+.stun.*.*.*.*.*"
    - "*.n.n.srv.nintendo.net"
    - "+.stun.playstation.net"
    - "xbox.*.*.microsoft.com"
    - "+.xboxlive.com"
    - "+.msftncsi.com"
    - "+.msftconnecttest.com"
    - WORKGROUP
    - "connect.rom.miui.com"
    - "connectivitycheck.platform.hicloud.com"
    - "wifi.vivo.com.cn"
    - "www.qualcomm.cn"
    - "+.ntp.org.cn"
    - "+.pool.ntp.org"
    - "ntp.aliyun.com"
    - "ntp.ntsc.ac.cn"
    - "ntp.tencent.com"
    - "time.apple.com"
    - "time.windows.com"
  default-nameserver:
    - 223.5.5.5
    - 8.8.8.8
  # 更多 DNS 参考: https://senzyo.pages.dev/2022-22/
  nameserver-policy:
    "geosite:cn":
      - tls://223.5.5.5
      - tls://1.12.12.12
      - https://223.5.5.5/dns-query
      - https://1.12.12.12/dns-query
  nameserver:
    - "tls://8.8.8.8#🌏 日韩台新"
    - "tls://1.1.1.1#🌏 日韩台新"
    - "https://8.8.8.8/dns-query#🌏 日韩台新"
    - "https://1.1.1.1/dns-query#🌏 日韩台新"
  proxy-server-nameserver:
    - tls://8.8.8.8
    - tls://1.1.1.1
    - https://8.8.8.8/dns-query
    - https://1.1.1.1/dns-query


proxy-groups:
  - name: 🚀 节点选择
    type: select
    disable-udp: false
    proxies:
      - 🌏 日韩台新
      - DIRECT
      - 📌 手动切换
      - 🇭🇰 香港节点
      - 🇯🇵 日本节点
      - 🇰🇷 韩国节点
      - 🇹🇼 台湾节点
      - 🇸🇬 新加坡节点
      - 🇺🇸 美国节点
  - name: 📌 手动切换
    type: select
    disable-udp: false
    exclude-filter: "剩余|流量|有效|时间|到期|expire|地址|网址|官网"
    use:
      - Provider
  - name: 🌏 日韩台新
    type: url-test
    disable-udp: false
    # 测试节点延迟的时间间隔, 单位为 s, 此处仅影响 proxies 下的节点, 不影响 use 下的节点
    # interval: 300
    # lazy 默认为 true, 未选择到当前策略组时,则不会进行测试
    # lazy: false
    # 当 (某一节点的延迟) < (当前节点的延迟-容差) 时, 才会切换到新的节点。默认值为 0ms, 可选项
    # tolerance: 20
    url: "https://www.gstatic.com/generate_204"
    filter: "🇯🇵|日本|JP|Japan|🇰🇷|韩国|KR|South Korea|🇹🇼|台湾|TW|Taiwan|🇸🇬|新加坡|SG|Singapore"
    use:
      - Provider
  - name: 🇭🇰 香港节点
    type: url-test
    disable-udp: false
    url: "https://www.gstatic.com/generate_204"
    filter: "🇭🇰|香港|HK|Hong Kong"
    use:
      - Provider
  - name: 🇯🇵 日本节点
    type: url-test
    disable-udp: false
    url: "https://www.gstatic.com/generate_204"
    filter: "🇯🇵|日本|JP|Japan"
    use:
      - Provider
  - name: 🇰🇷 韩国节点
    type: url-test
    disable-udp: false
    url: "https://www.gstatic.com/generate_204"
    filter: "🇰🇷|韩国|KR|South Korea"
    use:
      - Provider
  - name: 🇹🇼 台湾节点
    type: url-test
    disable-udp: false
    url: "https://www.gstatic.com/generate_204"
    filter: "🇹🇼|台湾|TW|Taiwan"
    use:
      - Provider
  - name: 🇸🇬 新加坡节点
    type: url-test
    disable-udp: false
    url: "https://www.gstatic.com/generate_204"
    filter: "🇸🇬|新加坡|SG|Singapore"
    use:
      - Provider
  - name: 🇺🇸 美国节点
    type: url-test
    disable-udp: false
    url: "https://www.gstatic.com/generate_204"
    filter: "🇺🇸|美国|US|USA|United States"
    use:
      - Provider
  - name: 🤖 Ai
    type: select
    disable-udp: false
    proxies:
      - 🌏 日韩台新
      - 📌 手动切换
      - 🇯🇵 日本节点
      - 🇰🇷 韩国节点
      - 🇹🇼 台湾节点
      - 🇸🇬 新加坡节点
      - 🇺🇸 美国节点
  - name: ☁️ OneDrive
    type: select
    disable-udp: false
    proxies:
      - DIRECT
      - 🚀 节点选择
      - 📌 手动切换
  - name: 🎮 游戏平台
    type: select
    disable-udp: false
    proxies:
      - 🚀 节点选择
      - DIRECT
      - 📌 手动切换
      - 🌏 日韩台新
      - 🇭🇰 香港节点
      - 🇯🇵 日本节点
      - 🇰🇷 韩国节点
      - 🇹🇼 台湾节点
      - 🇸🇬 新加坡节点
      - 🇺🇸 美国节点
  - name: 🐟 漏网之鱼
    type: select
    disable-udp: false
    proxies:
      - 🚀 节点选择
      - DIRECT
      - 📌 手动切换

rules:
  - DOMAIN-SUFFIX,bard.google.com,🇺🇸 美国节点
  - DOMAIN-SUFFIX,mangafuna.xyz,🚀 节点选择
  # GeoSite, https://github.com/MetaCubeX/meta-rules-dat?tab=readme-ov-file#geositedatgeositedb-内容
  - GEOSITE,category-ads-all,REJECT
  - GEOIP,private,DIRECT,no-resolve
  - GEOSITE,private,DIRECT
  - RULE-SET,NTPService,DIRECT
  - GEOSITE,tracker,DIRECT
  - GEOSITE,category-games@cn,DIRECT
  - GEOSITE,category-games,🎮 游戏平台
  - GEOSITE,onedrive,☁️ OneDrive
  - RULE-SET,Clash-Ai.yaml,🤖 Ai
  - GEOSITE,geolocation-!cn,🚀 节点选择
  - RULE-SET,CloudCN,DIRECT
  - GEOIP,cn,DIRECT,no-resolve
  - GEOSITE,cn,DIRECT
  - MATCH,🐟 漏网之鱼

proxy-providers:
  Provider:
    type: http
    # 因为 clash premium core 更新 providers 时不带 User-Agent, 会造成机场返回的订阅信息可能不符合 clash 的格式。可以在订阅连接后添加 `&flag=clash` 来指定。
    # 而 clash meta core 因为有 global-ua 设置项, 一般不用添加 `&flag=clash` 来指定, 但是有的机场需要添加 `&flag=clashmeta` 来指定。
    url: "https://example.com/xxx&flag=clashmeta"
    # 更新订阅的时间间隔, 单位为 s
    interval: 43200
    path: ./Provider.yaml
    health-check:
      enable: true
      # 测试节点延迟的时间间隔, 单位为 s, 此处仅影响 proxy-group 中 use 下的节点
      interval: 300
      lazy: false
      url: https://www.gstatic.com/generate_204

rule-providers:
  Clash-Ai.yaml:
    type: http
    behavior: classical
    url: https://ghproxy.net/https://gist.githubusercontent.com/senzyo/ba4885ed6b5e4b01f401fa3755d3a27d/raw/Clash-Ai.yaml
    path: ./rule-providers/Clash-Ai.yaml
    # 更新规则的时间间隔, 单位为 s
    interval: 604800
  NTPService:
    type: http
    behavior: classical
    url: https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/NTPService/NTPService.yaml
    path: ./rule-providers/NTPService.yaml
    interval: 604800
  CloudCN:
    type: http
    behavior: classical
    url: https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Cloud/CloudCN/CloudCN.yaml
    path: ./rule-providers/CloudCN.yaml
    interval: 604800
